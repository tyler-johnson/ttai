apiVersion: batch/v1
kind: Job
metadata:
  name: temporal-namespace-setup
  namespace: ttai
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: temporalio/admin-tools:1.29.1-tctl-1.18.4-cli-1.5.0
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for Temporal frontend to be ready..."
              until temporal operator cluster health --address temporal-frontend:7233 2>/dev/null | grep -q SERVING; do
                echo "Temporal not ready yet, waiting..."
                sleep 5
              done
              echo "Temporal is ready!"

              # Check if default namespace exists
              if temporal operator namespace describe default --address temporal-frontend:7233 2>/dev/null; then
                echo "Namespace 'default' already exists"
              else
                echo "Creating namespace 'default'..."
                temporal operator namespace create default \
                  --address temporal-frontend:7233 \
                  --retention 72h \
                  --description "Default namespace for TTAI workflows"
                echo "Namespace 'default' created successfully"
              fi
